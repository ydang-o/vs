<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.voting.mapper.VoteDelegateMapper">

    <insert id="insert" parameterType="com.voting.entity.VoteDelegate" useGeneratedKeys="true" keyProperty="id">
        insert into vote_delegate (vote_task_id, from_partner_id, to_partner_id, proof_file, status, create_time)
        values (#{voteTaskId}, #{fromPartnerId}, #{toPartnerId}, #{proofFile}, #{status}, #{createTime})
    </insert>

    <select id="pageQuery" resultType="com.voting.vo.DelegateVO">
        select
            vd.id,
            vd.vote_task_id,
            p.title as proposal_title,
            vd.from_partner_id,
            u1.real_name as from_partner_name,
            vd.to_partner_id,
            u2.real_name as to_partner_name,
            vd.proof_file,
            vd.status,
            vd.create_time
        from vote_delegate vd
        left join vote_task vt on vd.vote_task_id = vt.id
        left join proposal p on vt.proposal_id = p.id
        left join partner p1 on vd.from_partner_id = p1.id
        left join sys_user u1 on p1.user_id = u1.id
        left join partner p2 on vd.to_partner_id = p2.id
        left join sys_user u2 on p2.user_id = u2.id
        <where>
            <if test="voteTaskId != null">
                and vd.vote_task_id = #{voteTaskId}
            </if>
            <if test="fromPartnerId != null">
                and vd.from_partner_id = #{fromPartnerId}
            </if>
            <if test="toPartnerId != null">
                and vd.to_partner_id = #{toPartnerId}
            </if>
            <if test="status != null">
                and vd.status = #{status}
            </if>
        </where>
        order by vd.create_time desc
    </select>

    <select id="getByVoteTaskIdAndFromPartnerId" resultType="com.voting.entity.VoteDelegate">
        select * from vote_delegate 
        where vote_task_id = #{voteTaskId} and from_partner_id = #{fromPartnerId}
    </select>

    <select id="getById" resultType="com.voting.entity.VoteDelegate">
        select * from vote_delegate where id = #{id}
    </select>

    <update id="updateStatus">
        update vote_delegate set status = #{status} where id = #{id}
    </update>

    <select id="listByVoteTaskIdAndToPartnerId" resultType="com.voting.entity.VoteDelegate">
        select * from vote_delegate 
        where vote_task_id = #{voteTaskId} 
          and to_partner_id = #{toPartnerId}
          and status = 1
    </select>

</mapper>
