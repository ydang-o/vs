<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.voting.mapper.VoteTaskMapper">

    <insert id="insert" parameterType="com.voting.entity.VoteTask" useGeneratedKeys="true" keyProperty="id">
        insert into vote_task (proposal_id, start_time, end_time, vote_type, vote_strategy, pass_rate, status, create_time, creator_id)
        values (#{proposalId}, #{startTime}, #{endTime}, #{voteType}, #{voteStrategy}, #{passRate}, #{status}, #{createTime}, #{creatorId})
    </insert>

    <select id="getById" resultType="com.voting.entity.VoteTask">
        select * from vote_task where id = #{id}
    </select>

    <select id="pageQuery" resultType="com.voting.vo.VoteTaskVO">
        select
            vt.id,
            vt.proposal_id,
            p.title as proposal_title,
            p.proposal_no,
            vt.start_time,
            vt.end_time,
            vt.vote_type,
            vt.vote_strategy,
            vt.pass_rate,
            vt.status,
            vt.create_time,
            (select count(*) from vote_task_partner where vote_task_id = vt.id) as partner_count,
            (select count(*) from vote_task_partner where vote_task_id = vt.id and has_voted = 1) as voted_count,
            case 
                when (select count(*) from vote_task_partner where vote_task_id = vt.id) = 0 then 0
                else round((select count(*) from vote_task_partner where vote_task_id = vt.id and has_voted = 1) * 100.0 / (select count(*) from vote_task_partner where vote_task_id = vt.id), 0)
            end as progress
        from vote_task vt
        left join proposal p on vt.proposal_id = p.id
        <where>
            <if test="proposalId != null">
                and vt.proposal_id = #{proposalId}
            </if>
            <if test="voteStrategy != null">
                and vt.vote_strategy = #{voteStrategy}
            </if>
            <if test="status != null">
                and vt.status = #{status}
            </if>
        </where>
        order by vt.create_time desc
    </select>

    <select id="getDetailById" resultType="com.voting.vo.VoteTaskDetailVO">
        select
            vt.id,
            vt.proposal_id,
            p.title as proposal_title,
            p.proposal_no,
            p.content as proposal_content,
            vt.start_time,
            vt.end_time,
            vt.vote_type,
            vt.vote_strategy,
            vt.pass_rate,
            vt.status,
            vt.create_time,
            (select count(*) from vote_task_partner where vote_task_id = vt.id) as partner_count,
            (select count(*) from vote_task_partner where vote_task_id = vt.id and has_voted = 1) as voted_count,
            case 
                when (select count(*) from vote_task_partner where vote_task_id = vt.id) = 0 then 0
                else round((select count(*) from vote_task_partner where vote_task_id = vt.id and has_voted = 1) * 100.0 / (select count(*) from vote_task_partner where vote_task_id = vt.id), 0)
            end as progress,
            (select count(*) from vote_record where vote_task_id = vt.id and vote_option = 1) as agree_count,
            (select count(*) from vote_record where vote_task_id = vt.id and vote_option = 2) as reject_count,
            (select count(*) from vote_record where vote_task_id = vt.id and vote_option = 3) as abstain_count
        from vote_task vt
        left join proposal p on vt.proposal_id = p.id
        where vt.id = #{id}
    </select>

    <update id="updateStatus">
        update vote_task set status = #{status} where id = #{id}
    </update>

    <select id="getByProposalId" resultType="com.voting.entity.VoteTask">
        select * from vote_task where proposal_id = #{proposalId} limit 1
    </select>

</mapper>
